<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² | Quiz App</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="icon.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2D65FF; --bg: #F8FAFF; --card: #FFFFFF;
            --text: #1A1C1E; --sub: #7C828A; --accent: #FF9500;
            --green: #10B981; --red: #FF3B30; --shadow: 0 10px 30px rgba(45, 101, 255, 0.08);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: var(--bg); color: var(--text); margin: 0; padding-bottom: 100px;
        }
        .container { max-width: 450px; margin: auto; padding: 20px; }

        /* Ø§Ø³ØªØ§ÛŒÙ„ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ Ùˆ Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§ */
        .stat-card { background: var(--card); padding: 15px; border-radius: 20px; text-align: center; box-shadow: var(--shadow); }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin: 20px 0; }
        .quiz-item {
            background: var(--card); border-radius: 22px; padding: 18px;
            display: flex; align-items: center; gap: 15px; margin-bottom: 12px;
            box-shadow: var(--shadow); cursor: pointer;
        }
        .quiz-icon-box { width: 45px; height: 45px; background: rgba(45, 101, 255, 0.1); color: var(--primary); border-radius: 14px; display: flex; align-items: center; justify-content: center; }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ ØªØ§ÛŒÙ…Ø± Ùˆ Ø§Ù…ØªØ­Ø§Ù† */
        .timer-box { background: var(--accent); color: white; padding: 10px 25px; border-radius: 20px; display: inline-flex; align-items: center; gap: 10px; font-weight: bold; margin-bottom: 20px; }
        .option { background: white; border: 2px solid #F0F4F8; border-radius: 18px; padding: 15px; margin-bottom: 12px; display: flex; justify-content: space-between; cursor: pointer; transition: 0.2s; }
        .option.selected { border-color: var(--primary); background: rgba(45, 101, 255, 0.05); }
        .btn-main { background: var(--primary); color: white; border: none; border-radius: 18px; padding: 18px; width: 100%; font-weight: bold; cursor: pointer; box-shadow: 0 8px 20px rgba(45,101,255,0.2); }

        /* Ù†ÙˆØ§Ø± Ù†Ø§ÙˆØ¨Ø±ÛŒ */
        .bottom-nav { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 450px; background: white; display: flex; justify-content: space-around; padding: 15px 0; border-radius: 30px 30px 0 0; box-shadow: 0 -5px 25px rgba(0,0,0,0.05); }
        .nav-item { border: none; background: none; color: #BDC3C7; font-size: 0.75rem; text-align: center; }
        .nav-item.active { color: var(--primary); }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="container">
        <div id="page-dashboard">
            <h3>Ø³Ù„Ø§Ù… Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¹Ø²ÛŒØ² ğŸ‘‹</h3>
            <div class="stats-grid">
                <div class="stat-card"><h3 id="stat-total">Û°</h3><p style="font-size:0.7rem">Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§</p></div>
                <div class="stat-card"><h3 id="stat-avg">Û°Ùª</h3><p style="font-size:0.7rem">Ø§Ù…ØªÛŒØ§Ø²</p></div>
                <div class="stat-card"><h3 id="stat-rank">--</h3><p style="font-size:0.7rem">Ø±ØªØ¨Ù‡</p></div>
            </div>
            <h4 style="margin-top:25px">Ø¢Ø²Ù…ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ù…Ù†</h4>
            <div id="quiz-list-holder"></div>
            <button class="btn-main" style="margin-top:20px" onclick="showView('page-add')">+ Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø²Ù…ÙˆÙ† Ø¬Ø¯ÛŒØ¯</button>
        </div>

        <div id="page-add" class="hidden">
            <div class="stat-card" style="padding:30px">
                <h4>Ù„ÛŒÙ†Ú© Ø¢Ø²Ù…ÙˆÙ† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</h4>
                <input type="text" id="quiz-link-input" style="width:100%; padding:15px; margin:20px 0; border-radius:12px; border:1px solid #ddd; text-align:center" placeholder="https://...">
                <button class="btn-main" onclick="processIncomingLink(document.getElementById('quiz-link-input').value)">ØªØ§ÛŒÛŒØ¯ Ùˆ Ø«Ø¨Øª</button>
                <button onclick="showView('page-dashboard')" style="background:none; border:none; color:var(--red); margin-top:15px; cursor:pointer">Ø§Ù†ØµØ±Ø§Ù</button>
            </div>
        </div>

        <div id="view-exam" class="hidden" style="text-align: center;">
            <div class="timer-box"><i class="fas fa-clock"></i><span id="timer-display">00:00</span></div>
            <div class="stat-card" style="text-align: right; padding:25px">
                <small id="q-counter" style="color:var(--sub)"></small>
                <h3 id="q-text" style="margin:15px 0 25px 0"></h3>
                <div id="options-list"></div>
            </div>
            <button class="btn-main" style="margin-top:20px" onclick="handleNextStep()">Ø«Ø¨Øª Ùˆ Ù…Ø±Ø­Ù„Ù‡ Ø¨Ø¹Ø¯</button>
        </div>

        <div id="view-result" class="hidden" style="text-align: center;">
            <div class="stat-card">
                <i class="fas fa-trophy" style="font-size:3rem; color:var(--accent); margin-bottom:15px"></i>
                <h2>Ø¢Ø²Ù…ÙˆÙ† ØªÙ…Ø§Ù… Ø´Ø¯!</h2>
                <p>Ù†Ù…Ø±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ø´Ù…Ø§:</p>
                <h1 id="final-score" style="color:var(--primary)"></h1>
                <button class="btn-main" onclick="location.reload()">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø®Ø§Ù†Ù‡</button>
            </div>
        </div>
    </div>

    <div class="bottom-nav">
        <button class="nav-item active"><i class="fas fa-home"></i><br>Ø®Ø§Ù†Ù‡</button>
        <button class="nav-item"><i class="fas fa-chart-line"></i><br>Ø¹Ù…Ù„Ú©Ø±Ø¯</button>
        <button class="nav-item"><i class="fas fa-user"></i><br>Ù¾Ø±ÙˆÙØ§ÛŒÙ„</button>
    </div>

    <script>
        let db = JSON.parse(localStorage.getItem('quiz_db_v1')) || { quizzes: [], history: [] };
        let currentQuiz = null, qIndex = 0, score = 0, timerInterval, timeLeft, selectedOpt = null;

        function saveDB() { localStorage.setItem('quiz_db_v1', JSON.stringify(db)); }

        function showView(id) {
            ['page-dashboard', 'page-add', 'view-exam', 'view-result'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        // Û±. Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù„ÛŒÙ†Ú© Ø§Ø¯Ù…ÛŒÙ†
        function processIncomingLink(url) {
            if (!url || !url.includes('data=')) return alert('Ù„ÛŒÙ†Ú© Ù†Ø§Ù…Ø¹ØªØ¨Ø±!');
            try {
                const b64 = url.split('data=')[1];
                const data = JSON.parse(decodeURIComponent(escape(atob(b64))));
                if (!db.quizzes.find(q => q.id === data.id)) {
                    db.quizzes.push(data);
                    saveDB();
                }
                startExam(data);
            } catch(e) { alert('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§'); }
        }

        // Û². Ø´Ø±ÙˆØ¹ Ø¢Ø²Ù…ÙˆÙ† Ùˆ ØªØ§ÛŒÙ…Ø±
        function startExam(quiz) {
            currentQuiz = quiz; qIndex = 0; score = 0;
            timeLeft = parseInt(quiz.time) * 60;
            showView('view-exam');
            renderQuestion();
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                let m = Math.floor(timeLeft / 60), s = timeLeft % 60;
                document.getElementById('timer-display').innerText = `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
                if (timeLeft <= 0) { clearInterval(timerInterval); finishExam(); }
                timeLeft--;
            }, 1000);
        }

        function renderQuestion() {
            const q = currentQuiz.questions[qIndex];
            document.getElementById('q-counter').innerText = `Ø³ÙˆØ§Ù„ ${qIndex + 1} Ø§Ø² ${currentQuiz.questions.length}`;
            document.getElementById('q-text').innerText = q.t;
            const list = document.getElementById('options-list');
            list.innerHTML = ''; selectedOpt = null;
            q.o.forEach((opt, i) => {
                const div = document.createElement('div');
                div.className = 'option';
                div.innerHTML = `<span>${opt}</span><i class="far fa-circle"></i>`;
                div.onclick = () => {
                    document.querySelectorAll('.option').forEach(el => el.classList.remove('selected'));
                    div.classList.add('selected'); selectedOpt = i;
                };
                list.appendChild(div);
            });
        }

        function handleNextStep() {
            if (selectedOpt === null) return alert('Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ú¯Ø²ÛŒÙ†Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯');
            if (selectedOpt === currentQuiz.questions[qIndex].c) score++;
            qIndex++;
            if (qIndex < currentQuiz.questions.length) renderQuestion(); else finishExam();
        }

        function finishExam() {
            clearInterval(timerInterval);
            document.getElementById('final-score').innerText = `${score} Ø§Ø² ${currentQuiz.questions.length}`;
            db.history.push({ title: currentQuiz.title, score: score, total: currentQuiz.questions.length });
            saveDB();
            showView('view-result');
        }

        function updateDashboard() {
            const holder = document.getElementById('quiz-list-holder');
            holder.innerHTML = '';
            document.getElementById('stat-total').innerText = db.quizzes.length;
            db.quizzes.forEach(q => {
                const div = document.createElement('div');
                div.className = 'quiz-item';
                div.onclick = () => startExam(q);
                div.innerHTML = `<div class="quiz-icon-box"><i class="fas fa-file-alt"></i></div>
                                 <div class="quiz-details"><h4>${q.title}</h4><p>${q.questions.length} Ø³ÙˆØ§Ù„ | ${q.time} Ø¯Ù‚ÛŒÙ‚Ù‡</p></div>`;
                holder.appendChild(div);
            });
        }

        // Ø¨Ø±Ø±Ø³ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù„ÛŒÙ†Ú© Ù‡Ù†Ú¯Ø§Ù… ÙˆØ±ÙˆØ¯
        window.onload = () => {
            updateDashboard();
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('data')) processIncomingLink(window.location.href);
        };
    </script>
</body>
</html>
